# 汇编初探（asm）

## 1、第一个汇编程序

```asm
	DB	0xeb, 0x4e, 0x90, 0x48, 0x45, 0x4c, 0x4c, 0x4f
	DB	0x49, 0x50, 0x4c, 0x00, 0x02, 0x01, 0x01, 0x00
	DB	0x02, 0xe0, 0x00, 0x40, 0x0b, 0xf0, 0x09, 0x00
	DB	0x12, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00
	DB	0x40, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x29, 0xff
	DB	0xff, 0xff, 0xff, 0x48, 0x45, 0x4c, 0x4c, 0x4f
	DB	0x2d, 0x4f, 0x53, 0x20, 0x20, 0x20, 0x46, 0x41
	DB	0x54, 0x31, 0x32, 0x20, 0x20, 0x20, 0x00, 0x00
	RESB	16
	DB	0xb8, 0x00, 0x00, 0x8e, 0xd0, 0xbc, 0x00, 0x7c
	DB	0x8e, 0xd8, 0x8e, 0xc0, 0xbe, 0x74, 0x7c, 0x8a
	DB	0x04, 0x83, 0xc6, 0x01, 0x3c, 0x00, 0x74, 0x09
	DB	0xb4, 0x0e, 0xbb, 0x0f, 0x00, 0xcd, 0x10, 0xeb
	DB	0xee, 0xf4, 0xeb, 0xfd, 0x0a, 0x0a, 0x68, 0x65
	DB	0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72
	DB	0x6c, 0x64, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00
	RESB	368
	DB	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x55, 0xaa
	DB	0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
	RESB	4600
	DB	0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
	RESB	1469432
```

### 1.1 根据汇编指令生成 `.img` 映像文件

根据 `.nas` 生成 `.img` 文件，[asm.bat 脚本](asm.bat)

执行脚本，输入文件名，例如 `imos01`，脚本详情如下。

```bat
@echo off

:input

cls

set fileName=

set /p fileName=Please enter a file name: 

if defined fileName (
    echo File name is %fileName%
    ..\..\tolset\z_tools\nask.exe %fileName%.nas %fileName%.img
    pause
) else (
    echo The file name cannot be empty
    pause
    goto input
)
```

### 1.2 运行 `imos01.img` 文件

运行 `run.bat`，然后指定映像名字 `imos01`

### 1.3 涉及指令介绍

- `DB` data byte，汇编杀手锏

- `RESB` reserve byte，地址占位，是汇编器 `NASM` 的伪命令

  RESB 10 就表示从现在的地址开始空出10个字节，`nask` 不仅仅将指定的地址空出来，还会在空出来的地址上自动填上 `0x00`，方便了很多。`0x`代表是十六进制数，和C语言一致。

## 2、上边的汇编程序有点不知所云，润色下吧

```asm
;imos
;TAB=4

; 下边这段是标准 FAT12 格式软盘专用的代码

	DB	0xeb, 0x4e, 0x90
	DB	"IMOSAMOS"		;启动区名称（8字节）
	DW	512				;每个扇区（sector）大小（must 512字节）
	DB	1				;簇（cluster）的大小（must 1个扇区）
	DW	1				;FAT的起始位置（一般从第一个扇区开始）
	DB	2				;FAT的个数（must 2）
	DW	224				;根目录大小（一般设成224）
	DW	2880			;该磁盘的大小（must 2880扇区）
	DB	0xf0			;磁盘种类（must 0xf0）
	DW	9				;FAT的长度（must 9扇区）
	DW	18				;1个磁道（track）有几个扇区（must 18）
	DW	2				;磁头数（must 2）
	DD	0				;不是有分区，必须是0
	DD	2880			;重写一次磁盘大小
	DB	0,0,0x29		;未知，固定
	DD	0xffffffff		;卷标号码
	DB	"IMOSAMOS   "	;磁盘名称（11字节）
	DB	"FAT12   "		;磁盘格式（8字节）
	RESB	18			;先空出18字节

;程序主体

	DB	0xb8, 0x00, 0x00, 0x8e, 0xd0, 0xbc, 0x00, 0x7c
	DB	0x8e, 0xd8, 0x8e, 0xc0, 0xbe, 0x74, 0x7c, 0x8a
	DB	0x04, 0x83, 0xc6, 0x01, 0x3c, 0x00, 0x74, 0x09
	DB	0xb4, 0x0e, 0xbb, 0x0f, 0x00, 0xcd, 0x10, 0xeb
	DB	0xee, 0xf4, 0xeb, 0xfd

;信息显示部分

	DB	0x0a, 0x0a		;两个换行
	DB	"Hello World by amos!"
	DB	0x0a			;换行
	DB	0

	RESB	0x1fe-$		;增加（0x1fe - $）个 0x00 占位，$指当前行字节数
	DB	0x55, 0xaa		;第一个扇区最后两个字节为 55 AA，标识第一扇区为启动区

;以下是启动区以外部分的输出

	DB	0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
	RESB	4600
	DB	0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
	RESB	1469432
```

### 2.1 生成 `.img` 文件

运行 `asm.bat`，生成 `imos02.img`

### 2.2 运行 `imos02.img` 文件

运行 `run-imos02.bat`

补充：或者运行 `run.bat`，然后指定映像名字 `imos02`

```bat
@echo off

set imgFile=imos02.img
set tolsetPath=E:\devops\imos\tolset

copy %imgFile% %tolsetPath%\z_tools\qemu\fdimage0.bin
%tolsetPath%\z_tools\make.exe -C %tolsetPath%\z_tools\qemu
```

- `imgFile` `.img` 文件名
- `tolsetPath` 工具包路径

### 2.3 涉及指令介绍

- `DB` data byte 可以直接指定字符串，汇编会自动查找字符对应编码，再一个字节一个字节排列起来
- `DW` data word 16位，也就是2个字节
- `DD` data double-world 32位，也就是4个字节